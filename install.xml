<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Collivery.net Extension v3.0.3.1</name>
    <code>mds</code>
    <version>1</version>
    <author>MDS Tech</author>
    <link>http://www.collivery.co.za</link>
    <!-- CONTROLLERS -->
    <!-- Admin Controllers -->
    <file path="catalog/controller/checkout/shipping_method.php">
        <operation>
            <search>
                <![CDATA[if (isset($this->session->data['shipping_methods'])) {]]>
            </search>
            <add position="before">
                <![CDATA[
        $collivery_method_available = false;
		foreach ($this->session->data['shipping_methods'] as $method_array){
		    if(isset($method_array['code']) && $method_array['code'] === 'mds' && count($method_array['quote'])) {
                $collivery_method_available = true;
                break;
            }

        }
		if($collivery_method_available){
            $data['error_warning'] = 'No Collivery.net Shipping Methods Available!';
        }
                ]]>
            </add>
        </operation>

    </file>
    <file path="system/engine/controller.php">
        <operation>
            <search>
                <![CDATA[public function __get($key) {]]>
            </search>
            <add position="after">
                <![CDATA[
        /** @collivery-config */
        if(!$this->registry->has('collivery')){
            $query = $this->registry->get('db')->query("select u.value as username, p.value as password, d.value as is_demo from " . DB_PREFIX . "setting as p left join " . DB_PREFIX . "setting as u on(u.code=p.code) left join " . DB_PREFIX . "setting as d on(d.code=p.code) where u.code='shipping_mds' and p.code='shipping_mds' and p.code='shipping_mds_is_demo' and u.key='shipping_mds_username' and p.key='shipping_mds_password'");
            if(!$query->num_rows){
                $is_demo = true;
                $username = '';
                $password = '';
            }else{
                list('username' => $username, 'password' => $password, 'is_demo'=> $is_demo) = $query->row;
            }
            $config = array(
                'log' => $this->registry->get('log'),
                'cache_dir' => DIR_SYSTEM . '/library/cache/',
                'app_name' => 'MDS Collivery.net',
                'app_version' => '1.0.1',
                'app_host' => 'Opencart ' . VERSION,
                'app_url' => $_SERVER['HTTP_HOST'],
                'user_email' => $username ,
                'user_password' => $password,
                'demo' =>  $is_demo
            );

            $collivery_library = DIR_SYSTEM . 'library/mds/Collivery.php';
            if(is_file($collivery_library)){
                include_once $collivery_library;
                $this->registry->set('collivery', new \Mds\Collivery($config));
                $collivery = $this->registry->get('collivery');
                if($collivery->authenticate() &&  $collivery->isAuthError()){
                    $this->registry->set('error', array('warning' => 'Collivery.net Shipping Plugin Auth Error'));
                }
            }
        }
        /** @endcollivery-config */
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/model/checkout/order.php">
        <operation>
            <search>
                <![CDATA[public function addOrder($data) {]]>
            </search>
            <add position="after">
                <![CDATA[
        /** @collivery-data */
        if($this->collivery){
            $default_address =  $this->collivery->getDefaultAddress();
            $sql_data['collivery_from_address_id'] = $default_address['address']['address_id'];
            $sql_data['collivery_from_contact_id'] = current($default_address['contacts'])['contact_id'];

            if(isset($data['shipping_collivery_location_type'], $data['shipping_collivery_town'], $data['shipping_collivery_suburb'])){
                $sql_data['collivery_location_type'] = $data['shipping_collivery_location_type'];
                $sql_data['collivery_town'] = $data['shipping_collivery_town'];
                $sql_data['collivery_suburb'] = $data['shipping_collivery_suburb'];
            }
            $extra_sql = '';
            foreach($sql_data as $column => $value){
                $extra_sql .= $column ."='" . $value . "',";
            }
        }

        /** @endcollivery-data */
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["INSERT INTO `" . DB_PREFIX . "order` SET]]>
            </search>
            <add position="replace">
                <![CDATA["INSERT INTO `" . DB_PREFIX . "order` SET {$extra_sql}]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/confirm.php">
        <operation>
            <search>
                <![CDATA[$this->load->model('account/customer');]]>
            </search>
            <add position="replace">
                <![CDATA[
                    $this->load->model('account/customer');
                    $this->load->model('account/address');
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$order_data['shipping_country_id'] = $this->session->data['shipping_address']['country_id'];]]>
            </search>
            <add position="replace">
                <![CDATA[
                $order_data['shipping_country_id'] = $this->session->data['shipping_address']['country_id'];
				$order_data['shipping_collivery_town'] = $this->session->data['shipping_address']['collivery_town'];
				$order_data['shipping_collivery_suburb'] = $this->session->data['shipping_address']['collivery_suburb'];
				$order_data['shipping_collivery_location_type'] = $this->session->data['shipping_address']['collivery_location_type'];
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/model/setting/event.php">
        <operation>
            <search>
                <![CDATA[class ModelSettingEvent extends Model {]]>
            </search>
            <add position="after">
                <![CDATA[
protected  $collivery_fields = array(
    'order' => array(
        'collivery_from_address_id',
        'collivery_from_contact_id',
        'collivery_to_address_id',
        'collivery_to_contact_id',
        'collivery_town',
        'collivery_suburb',
        'collivery_location_type',
        'collivery_price_data',
        'collivery_service_type_id',
        'collivery_service_type_id',
        'waybill_id'
    ),
    'address' => array(
        'collivery_town',
        'collivery_suburb',
        'collivery_location_type',
    )
);
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function deleteEvent(]]>
            </search>
            <add position="before">
                <![CDATA[
    public function installColliveryShippingPlugin(){

        $collivery_dir = DIR_SYSTEM . 'library/mds/';
        if(is_dir($collivery_dir)){
            $this->addFieldsInTables();
            $this->addCustomFields();
        }

    }
    public function uninstallColliveryShippingPlugin(){
        $this->addFieldsInTables(false);
        $this->addCustomFields(false);
    }
    public function addFieldsInTables($add = true){
        if($add === true){
            foreach ($this->collivery_fields as $table => $fields){
                foreach($fields as $field){
                    $sql = "IF NOT EXISTS( SELECT NULL
                    FROM INFORMATION_SCHEMA.COLUMNS
                   WHERE table_name = '" . DB_PREFIX. "{$table}'
                     AND table_schema = '" . DB_DATABASE . "'
                     AND column_name = '{$field}')  THEN
                   ALTER TABLE `" . DB_PREFIX. "{$table}` ADD `{$field}` TEXT NULL DEFAULT NULL;
                END IF;";
                    $this->db->query($sql);
                }
            }
        }elseif($add === false){
            foreach ($this->collivery_fields as $table => $fields){
                foreach($fields as $field){
                    $sql = "IF EXISTS( SELECT NULL
                    FROM INFORMATION_SCHEMA.COLUMNS
                   WHERE table_name = '" . DB_PREFIX. "{$table}'
                     AND table_schema = '" . DB_DATABASE . "'
                     AND column_name = '{$field}')  THEN
                   ALTER TABLE " . DB_PREFIX . "{$table} DROP COLUMN {$field};
                   END IF;";
                    $this->db->query($sql);
                }

            }
            $dir = DIR_SYSTEM . 'library/mds/';
            /**
            if(is_dir($dir)){
            $it = new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS);
            $files = new RecursiveIteratorIterator($it, RecursiveIteratorIterator::CHILD_FIRST);
            foreach($files as $file) {
            if ($file->isDir()){
            rmdir($file->getRealPath());
            } else {
            unlink($file->getRealPath());
            }
            }
            rmdir($dir);
            }
            $this->deleteEventByCode('mds');

             */
        }

    }
    public function addCustomFields($add = true) {
        $fields = array ( "10" => "Location Type", "8" => "Town", "9" => "Suburb" );
        $relationship = array('custom_field_description', 'custom_field_customer_group', 'custom_field_value_description', 'custom_field_value', 'custom_field');

	    if($add === true){
            foreach ($fields as $key => $field) {
                $customField = $this->db->query('SELECT * FROM `'. DB_PREFIX .'custom_field_description` where name ="' . $field . '"');
                if($customField->num_rows == 0) {
                    $this->db->query("INSERT INTO `" . DB_PREFIX . "custom_field` SET type = \"select\", location = \"address\", status = 1, sort_order = '" . (int)$key . "'");
                    $custom_field_id = $this->db->getLastId();
                    $this->db->query("INSERT INTO " . DB_PREFIX . "custom_field_description SET custom_field_id = '" . (int)$custom_field_id . "', language_id = 1, name = '" . $this->db->escape($field) . "'");
                    $this->db->query("INSERT INTO " . DB_PREFIX . "custom_field_customer_group SET custom_field_id = '" . (int)$custom_field_id . "', customer_group_id = 1, required = 0");
                }
            }
        }else{
            foreach ($fields as $key => $field) {
                $customField = $this->db->query('SELECT * FROM `'. DB_PREFIX .'custom_field_description` where name ="' . $field . '"');
                if($customField->num_rows) {
                    $customField = (object) $customField->row;
                    foreach($relationship as $table){
                        $query = $this->db->query('select * from ' . DB_PREFIX . $table . " where custom_field_id='".$customField->custom_field_id."'");
                        if($query->num_rows){
                            $this->db->query('DELETE FROM `' . DB_PREFIX . $table . '` WHERE `' . DB_PREFIX . $table . '`.`custom_field_id` = ' . $customField->custom_field_id);
                        }
                    }
                    $this->db->query('DELETE FROM `' . DB_PREFIX . 'custom_field_description` WHERE `' . DB_PREFIX .'custom_field_description`.`custom_field_id` = ' . $customField->custom_field_id);
                }
            }
        }
    }
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/guest.php">
        <operation>
            <search>
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields($customer_group_id);]]>
            </search>
            <add position="replace">
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields();]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$this->session->data['shipping_address']['zone_id'] = $this->request->post['zone_id'];]]>
            </search>
            <add position="replace">
                <![CDATA[
                $this->session->data['shipping_address']['zone_id'] = $this->request->post['zone_id'];
				$this->session->data['shipping_address']['collivery_town'] = $this->request->post['collivery_town'];
				$this->session->data['shipping_address']['collivery_suburb'] = $this->request->post['collivery_suburb'];
				$this->session->data['shipping_address']['collivery_location_type'] = $this->request->post['collivery_location_type'];
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$this->session->data['guest']['telephone'] = $this->request->post['telephone'];]]>
            </search>
            <add position="replace">
                <![CDATA[
                   $this->session->data['guest']['telephone'] = $this->request->post['telephone'];
                    /** @collivery-data */
                    $this->session->data['guest']['collivery_town'] = $this->request->post['collivery_town'];
                    $this->session->data['guest']['collivery_suburb'] = $this->request->post['collivery_suburb'];
                    $this->session->data['guest']['collivery_location_type'] = $this->request->post['collivery_location_type'];

                    /** @endcollivery-data */
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/guest.php|catalog/controller/checkout/register.php">
        <operation>
            <search>
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields($customer_group_id);]]>
            </search>
            <add position="replace">
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields();]]>
            </add>
        </operation>
    </file>
    <file path="admin/controller/sale/order.php">
        <operation>
            <search>
                <![CDATA[public function add() {]]>
            </search>
            <add position="before">
                <![CDATA[
    public function createColliveryAddress(){
        $order_id = $this->request->get['order_id'];
        if($order_id){
            $order_object = (object) $this->db->query('select * from '. DB_PREFIX . "order where order_id='$order_id'")->row;
            $post_data = (object) $this->request->post;
            if(!$order_object->waybill_id || ($order_object->collivery_town != $post_data->shipping_collivery_town || $order_object->collivery_suburb != $post_data->shipping_collivery_suburb)){ //if address is not created
                $address_data['street'] = $order_object->shipping_address_1;
                $address_data['location_type'] = $post_data->shipping_collivery_location_type;
                $address_data['suburb_id'] = $post_data->shipping_collivery_suburb;
                $address_data['town_id'] = $post_data->shipping_collivery_town;
                $address_data['custom_id'] = $order_object->customer_id;
                $address_data['full_name'] = $order_object->firstname . ' ' . $order_object->lastname;
                $address_data['cellphone'] = $order_object->telephone;
                $address_data['phone'] = $order_object->telephone;
                $address_data['email'] = $order_object->email;

                list('address_id' => $address_id, 'contact_id' => $contact_id) = $this->collivery->addAddress($address_data);
                $this->db->query('update ' .DB_PREFIX . 'order set collivery_town="'. $address_data['town_id']. '", collivery_suburb="'. $address_data['suburb_id']. '", collivery_location_type="'. $address_data['location_type']. '", collivery_to_address_id="' . $address_id .'", collivery_to_contact_id="' . $contact_id . '" where order_id="' . $order_object->order_id . '"');
            }
            $this->acceptAndCreateWaybill($order_id);
        }
    }

    public function acceptAndCreateWaybill($order_id)
    {
        $data = $this->db->query("select * from " . DB_PREFIX . "order where order_id='$order_id'")->row;
        if($data['collivery_from_address_id'] && $data['collivery_to_address_id']){ //if waybill is not created
            $data_object = (object) $data;
            $quote['parcels'] = [];
            $quote['collivery_from'] = $data_object->collivery_from_address_id;
            $quote['contact_from'] = $data_object->collivery_from_contact_id;
            $this->load->model('sale/order');
            $this->load->model('catalog/product');
            $order_products = $this->model_sale_order->getOrderProducts($data['order_id']);
            foreach ($order_products as $key => $order_product){
                $product_model = (object) $order_product;
                $product = (object) $this->model_catalog_product->getProduct($product_model->product_id);
                $quote['parcels'][$key]['width'] = $product->width;
                $quote['parcels'][$key]['height'] = $product->height;
                $quote['parcels'][$key]['length'] = $product->length;
                $quote['parcels'][$key]['weight'] = $product->weight;
            }
            list(1 => $service_type_id) = explode('.', $data['shipping_code']);
            $quote['collivery_to'] = $data_object->collivery_to_address_id;
            $quote['contact_to'] = $data_object->collivery_to_contact_id;
            $quote['service'] = $service_type_id;
            $quote['collivery_type'] = 2; //package
            $quote['cover'] = $this->config->get('mds_shipping_cover');
            $quote['rica'] = $this->config->get('mds_shipping_rica');
            $validated_collivery_data = $this->collivery->validate($quote);
            if($validated_collivery_data){
                $data['quote_data'] = $validated_collivery_data;
                $check = $this->db->query('select waybill_id from ' .DB_PREFIX . 'order where order_id="' . $data_object->order_id . '"')->row['waybill_id'];
                if(!$check){
                    $waybill_id = $this->collivery->addCollivery($validated_collivery_data);
                    if($waybill_id){
                        $this->db->query('update ' .DB_PREFIX . "order set `collivery_price_data`='". json_encode($validated_collivery_data)."', waybill_id='" . $waybill_id . "' where order_id='" . $data_object->order_id . "'");
                        if($this->config->get('shipping_mds_auto_accept_waybill')){
                            $this->collivery->acceptCollivery($waybill_id);
                        }
                    }
                }
            }
        }

        $data = $this->db->query("select * from " . DB_PREFIX . "order where order_id='$order_id'")->row;

        $waybill_id = $data['waybill_id'];
        $waybill_status = $this->collivery->getColliveryStatus($waybill_id);
        $response['delivery_date'] = 'N/A';
        $response['waybill_status'] = 'N/A';
        if(is_array($waybill_status)){
            if(array_key_exists('status_text', $waybill_status)){
                $response['waybill_status'] = $waybill_status['status_text'];
            }
            if(array_key_exists('delivery_date', $waybill_status)){
                $response['delivery_date'] = $waybill_status['delivery_date'];
            }
        }
        $response['waybill_id'] = $waybill_id;
        $response['waybill_service'] = $data['shipping_method'];
        $response['collivery_from'] = $this->collivery->getAddress($data['collivery_from_address_id'])['nice_address'];
        $response['collivery_to'] = $this->collivery->getAddress($data['collivery_to_address_id'])['nice_address'];

        header('Content-Type: application/json');
        echo json_encode($response);
    }
                ]]>
            </add>
        </operation>

        <operation>
            <search index="1">
                <![CDATA[$this->load->model('localisation/order_status');]]>
            </search>
            <add position="before">
                <![CDATA[
    /** @collivery-data */


        list($code, $service_type_id) = explode('.', $data['shipping_code']);
        $data['is_mds'] = $code == 'mds';
        $location_types = $this->collivery->getLocationTypes();
        $towns = $this->collivery->getTowns();
        $suburbs = $this->collivery->getAllSuburbs();
        if($data['is_mds']){

            $data['collivery_services'] = $this->collivery->getServices();

            $order = $this->db->query('select * from ' . DB_PREFIX . 'order where order_id=' . $data['order_id'] )->row;

            foreach ($order as $column => $column_value){
                $data[$column] = $column_value;
            }

            if(!$data['collivery_from_address_id']){
                $address = $this->collivery->getDefaultAddress();
                list('address_id' => $address_id) = $address['address'];
                list('contact_id' => $contact_id) = current($address['contacts']);
                $data['collivery_from_address_id'] = $address_id;
                $this->db->query('update ' .DB_PREFIX . 'order set collivery_from_address_id="' . $address_id . '", collivery_from_contact_id="' . $contact_id .'" where order_id="' . $data['order_id'] . '"');
            }

            //Collivery collection address
            if($data['collivery_from_address_id']){
                $data['collivery_collection_address'] = $this->collivery->getAddress($data['collivery_from_address_id']);
            }
            //Collivery delivery address
            if($data['collivery_to_address_id']){
                $data['collivery_delivery_address'] = $this->collivery->getAddress($data['collivery_to_address_id']);
            }


            $data['waybill_service_name'] = $data['collivery_services'][$service_type_id];
            $data['waybill_service_id'] = $service_type_id;

            $order_products = $this->model_sale_order->getOrderProducts($data['order_id']);
            $this->load->model('catalog/product');

            $data['order_products'] = $order_products;
            if(!$data['waybill_id'] && $data['collivery_from_address_id'] && $data['collivery_to_address_id']){ //if waybill is not created
                $data_object = (object) $data;
                $quote['parcels'] = [];
                $quote['collivery_from'] = $data_object->collivery_from_address_id;
                $quote['contact_from'] = $data_object->collivery_from_contact_id;
                foreach ($order_products as $key => $order_product){
                    $product_model = (object) $order_product;
                    $product = (object) $this->model_catalog_product->getProduct($product_model->product_id);
                    $quote['parcels'][$key]['width'] = $product->width;
                    $quote['parcels'][$key]['height'] = $product->height;
                    $quote['parcels'][$key]['length'] = $product->length;
                    $quote['parcels'][$key]['weight'] = $product->weight;
                }
                $quote['collivery_to'] = $data_object->collivery_to_address_id;
                $quote['contact_to'] = $data_object->collivery_to_contact_id;
                $quote['service'] = $service_type_id;
                $quote['collivery_type'] = 2; //package
                $quote['cover'] = $this->config->get('mds_shipping_cover');
                $quote['rica'] = $this->config->get('mds_shipping_rica');
                $validated_collivery_data = $this->collivery->validate($quote);
                if($validated_collivery_data){
                    $data['quote_data'] = $validated_collivery_data;
                }
            }


            if($data['collivery_town']){
                $data['town'] = $towns[$data['collivery_town']];
            }
            if(!empty($suburbs) && isset($data['collivery_suburb'])){
                $data['suburb'] = $suburbs[$data['collivery_suburb']];
            }
            if($data['collivery_location_type']){
                $data['location_type'] = $location_types[$data['collivery_location_type']];
            }
            if($data['waybill_id']){
                //$data['waybill_info'] = $this->collivery->getColliveryStatus($data['waybill_id']);
                $data['waybill_status'] = $this->collivery->getStatus($data['waybill_id']);
                $data['waybill_pod'] = $this->collivery->getPod($data['waybill_id']);
                $data['waybill_enc'] = (string) base64_encode ($data['waybill_id']);
            }
        }
        /** @endcolivery-data */
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function getForm() {]]>
            </search>
            <add position="after">
                <![CDATA[
                    $this->load->language('extension/shipping/mds');
                    $data = $this->language->all();
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$data['footer'] = $this->load->controller('common/footer');]]>
            </search>
            <add position="after">
                <![CDATA[       $data['tab_mds'] = "Collivery.net";]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/checkout.php">
        <operation>
            <search>
                <![CDATA[public function country() {]]>
            </search>
            <add position="before">
                <![CDATA[
                    public function getTownSuburbs() {
                        $townId = $this->request->get['town_id'];
                        $respond = "";

                        foreach ($this->collivery->getSuburbs($townId) as $key => $sub) {
                            $respond .= '<option value="'.$key.'">'. $sub .'</option>';
                        }
                        echo $respond;
                    }
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/controller/sale/customer.php">
        <operation>
            <search>
                <![CDATA[public function transaction() {]]>
            </search>
            <add position="before">
                <![CDATA[
                    public function getTownSuburbs() {
                        $townId = $this->request->get['town_id'];
                        $respond = "";
                        foreach ($this->collivery->getSuburbs($townId) as $key => $sub) {
                            $respond .= '<option value="'.$key.'">'. $sub .'</option>';
                        }
                        echo $respond;
                    }
                ]]>
            </add>
        </operation>
    </file> <!-- !exist() -->
    <!-- End Admin Controllers -->
    <!-- Catalog Controllers -->

    <file path="catalog/model/account/address.php">
        <operation>
            <search>
                <![CDATA['address_id'     => $address_query->row['address_id'],]]>
            </search>
            <add position="replace">
                <![CDATA[
                'address_id'     => $address_query->row['address_id'],
				'collivery_town'     => $address_query->row['collivery_town'],
				'collivery_suburb'     => $address_query->row['collivery_suburb'],
				'collivery_location_type'     => $address_query->row['collivery_location_type'],
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function editAddress($address_id, $data) {]]>
            </search>
            <add position="after">
                <![CDATA[
                    $sql['collivery_town'] = $data['collivery_town'];
                    $sql['collivery_suburb'] = $data['collivery_suburb'];
                    $sql['collivery_location_type'] = $data['collivery_location_type'];
                    $string = '';
                    foreach($sql as $k => $v){
                        $string .= "$k='$v', ";
                    }
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["UPDATE " . DB_PREFIX . "address SET]]>
            </search>
            <add position="replace">
                <![CDATA["UPDATE " . DB_PREFIX . "address SET $string]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[public function addAddress($customer_id, $data) {]]>
            </search>
            <add position="after">
                <![CDATA[
        $sql['collivery_location_type'] = $data['collivery_location_type'];
        $sql['collivery_town'] = $data['collivery_town'];
        $sql['collivery_suburb'] = $data['collivery_suburb'];
        $string = '';
        foreach($sql as $k => $v){
            $string .= "$k='$v', ";
        }
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA["INSERT INTO " . DB_PREFIX . "address SET]]>
            </search>
            <add position="replace">
                <![CDATA["INSERT INTO " . DB_PREFIX . "address SET $string]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/account/address.php">
        <operation>
        <search>
            <![CDATA[if ($custom_field['location'] == 'address') {]]>
        </search>
        <add position="before">
            <![CDATA[//if($custom_field['name'] == 'Town' || $custom_field['name'] == 'Suburb' || $custom_field['name'] == 'Location Type')continue;]]>
        </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/shipping_address.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[
                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/payment_address.php">
        <operation>
            <search>
                <![CDATA[$address_id = $this->model_account_address->addAddress($this->customer->getId(), $this->request->post);]]>
            </search>
            <add position="after">
                <![CDATA[
                    /** @collivery-data */
					    $this->session->data['collivery_collection_address'] = $this->db->query("select * from " . DB_PREFIX . "address where address_id='$address_id'")->row;
                    /** @endcollivery-data */
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[
                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/payment_address.php|catalog/controller/checkout/shipping_address.php">
        <operation>
            <search index="1">
                <![CDATA[$custom_fields = $this->model_account_custom_field->getCustomFields($this->config->get('config_customer_group_id'));]]>
            </search>
            <add position="replace">
                <![CDATA[
                   $custom_fields = $this->model_account_custom_field->getCustomFields();
                ]]>
            </add>
        </operation>
        <operation>
            <search index="1">
                <![CDATA[if (!$json) {]]>
            </search>
            <add position="before">
                <![CDATA[
        /** @collivery-data */
        if(isset($this->request->post['address_id'])){
            $address_id = $this->request->post['address_id'];
            $result = $this->db->query("select collivery_town, collivery_suburb, collivery_location_type from " . DB_PREFIX . "address where address_id='$address_id'");
            if($result->num_rows){
                $address = (object) $result->row;
                if(!$address->collivery_town || !$address->collivery_suburb || !$address->collivery_location_type){
                    //redirect
                    $json['redirect'] =  "index.php?route=account/address/edit&address_id=$address_id";
                }
            }
        }
        /** @endcollivery-data */
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[
                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/account/register.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="replace">
                <![CDATA[
                    if (isset($custom_field['location']) && $custom_field['location'] == 'address') {
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/api/payment.php">
        <operation>
            <search>
                <![CDATA[if ($custom_field['required'] && empty($this->request->post['custom_field'][$custom_field['location']][$custom_field['custom_field_id']])) {]]>
            </search>
            <add position="replace">
                <![CDATA[
                    if ($custom_field['required'] && empty($this->request->post['custom_field'][$custom_field['custom_field_id']])) {
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/controller/api/shipping.php|catalog/controller/api/payment.php">
        <operation>
            <search>
                <![CDATA[if (if ($custom_field['location'] == 'address') {]]>
            </search>
            <add position="before">
                <![CDATA[if($custom_field['name'] == 'Town' || $custom_field['name'] == 'Suburb' || $custom_field['name'] == 'Location Type')continue;]]>
            </add>
        </operation>

    </file>
    <file path="catalog/controller/api/shipping.php">
        <operation>
            <search>
                <![CDATA['firstname'      => $this->request->post['firstname'],]]>
            </search>
            <add position="replace">
                <![CDATA[
                    'firstname'      => $this->request->post['firstname'],
                    'collivery_town'      => $this->request->post['shipping_collivery_town'],
                    'collivery_location_type'      => $this->request->post['shipping_collivery_location_type'],
                ]]>
            </add>
        </operation>

    </file>
    <file path="admin/model/sale/order.php">
        <operation>
            <search>
                <![CDATA['order_id'                => $order_query->row['order_id'],]]>
            </search>
            <add position="replace">
                'order_id'                => $order_query->row['order_id'],
                'waybill_id'                => $order_query->row['waybill_id'],
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation>
            <search>
                <![CDATA[: $('a[href=\'#tab-shipping\']')]]>
            </search>
            <add position="replace">
                <![CDATA[: $('a[href=\'#tab-mds\']')]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[$('#button-shipping-address').button('reset');]]>
            </search>
            <add position="replace">
                <![CDATA[//$('#button-shipping-address').button('reset');]]>
            </add>
        </operation>
        <operation>
            <search index="1">
                <![CDATA[$('a[href=\'#tab-total\']').tab('show');]]>
            </search>
            <add position="replace">
                <![CDATA[
                const colliveryElements = $(document).find('[name="shipping_collivery_town"], [name="shipping_collivery_suburb"], [name="shipping_collivery_location_type"]');
                      let errors = [];
                      colliveryElements.each(function() {
                            if(!$(this).val()){
                                alert('Please select Town, Suburb and Location Type');
                              errors.push(`${$(this).attr('name')} missing!`);
                            }
                       });
                      if(!errors.length){
                        //$('#yes-create-mds-address').click();
                        $.ajax({
                              url : `index.php?route=sale/order/createColliveryAddress&user_token=${window.user_token}&order_id={{ order_id }}`,
                              method:'post',
                              dataType: 'json',
                              data : $('#tab-shipping').find('select, textarea, input').serialize()
                            }).done(function(response){
                                var { waybill_id : waybill_id, waybill_status : waybill_status, waybill_service : waybill_service, collivery_from : collivery_from, collivery_to : collivery_to, delivery_date : delivery_date } = response,
             html = `
              <div class="row">
                          <div class="col-md-4 text-left">
                              <h4>
                                  Waybill No: ${ waybill_id } <b></b>
                              </h4>
                          </div>
                          <div class="col-md-4 text-center">
                              <h4>
                                  Service Type: ${ waybill_service }<b></b>
                              </h4>
                          </div>
                          <div class="col-md-4 text-right">
                              <h4>
                                  Delivery Date : ${ delivery_date }<b></b>
                              </h4>
                          </div>
                      </div>
                     <div class="row">
                      <div class="col-md-12">
                          <table class="table table-bordered">
                              <tbody>
                              <tr>
                                  <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>
                              </tr>
                              <tr>
                                  <td width="50%" class="text-center"><b>Collection Address</b></td>
                                  <td width="50%" class="text-center"><b>Delivery Address</b></td>
                              </tr>
                              <tr>
                                  <td>${ collivery_from }</td>
                                  <td>${ collivery_to }</td>
                              </tr>
                            </tbody>
                          </table>
                      </div>
                  </div>
                    <div class="row">
                      <div class="col-md-12">
                          <table class="table table-striped">
                              <thead>
                                <tr>
                                    <td>Status</td>
                                    <td>Delivery Date</td>
                                    <td>ETA</td>
                                </tr>
                              </thead>
                              <tbody>
                              <tr>
                                  <td></td>
                                  <td></td>
                                  <td></td>
                              </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
            `;

                $(document).find('#sub-tab-mds').html(html);
                }).always(function(){
                    $('a[href="#tab-mds"]').tab('show');
                    $('#button-shipping-address').button('reset');
                });
            }

                ]]>
            </add>
        </operation>
        <operation>
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[

                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[<li class="disabled"><a href="#tab-total" data-toggle="tab">5. {{ tab_total }}</a></li>]]>
            </search>
            <add position="replace">
                <![CDATA[
                    <li class="disabled">
                        <a href="#tab-mds" data-toggle="tab">
                            5. {{ tab_collivery }}
                        </a>
                    </li>
                    <li class="disabled">
                        <a href="#tab-total" data-toggle="tab">
                            6. {{ tab_total }}
                        </a>
                    </li>
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[return false;]]>
            </search>
            <add position="replace">
                <![CDATA[return false;]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[<div class="tab-pane" id="tab-total">]]>
            </search>
            <add position="before">
                <![CDATA[
            <div class="tab-pane" id="tab-mds">
   <div class="row">
      <div class="col-md-12 text-center">
         <img width="20%" alt="Collivery Logo" class="center" src="https://collivery.net/img/frontend/sliders/takealot-banner/collivery-logo.png" />
         <hr/>
      </div>
   </div>
   <div id="sub-tab-mds">
      {% if is_mds %}
      <div class="row">
         <div class="col-md-12">
            <table class="table table-bordered">
               <tbody>
                  <tr>
                     <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>
                  </tr>
                  <tr>
                     <td class="text-center"><b>Collection Address</b></td>
                     {% if collivery_delivery_address is not empty  %}
                     <td class="text-center"><b>Delivery Address</b></td>
                     {% else %}
                     <td>Town</td>
                     <td>Suburb</td>
                     <td>Location Type</td>
                     {% endif %}
                  </tr>
                  <tr>
                     <td>{{ collivery_collection_address.nice_address }}</td>
                     {% if collivery_delivery_address is not empty %}
                     <td>{{ collivery_delivery_address.nice_address }}</td>
                     {% else %}
                     <td>{{ town }}</td>
                     <td>{{ suburb }}</td>
                     <td>{{ location_type }}</td>
                     {% endif %}
                  </tr>
                  <tr>
                     <td class="text-center text-uppercase bg-warning" colspan="9">Collivery Status</td>
                  </tr>
               </tbody>
            </table>
         </div>
      </div>
      <div class="row">
         <div class="col-md-12">
            <table class="table table-striped">
               <thead>
                  <tr>
                     <td>Status</td>
                     <td>Delivery Date</td>
                     <td>ETA</td>
                  </tr>
               </thead>
               <tbody>
                  <tr>
                     <td>{{ waybill_info.status_text }}</td>
                     <td>{{ waybill_info.delivery_date }}</td>
                     <td>{{ waybill_info.eta_text }}</td>
                  </tr>
               </tbody>
            </table>
         </div>
      </div>
      {% else %}
      <div class="row">
         <div class="col-md-12">
            <br>
            <br>
            <h5 class="text-center text-info text-uppercase">Please not that the customer did not use Collivery.net shipping method</h5>
         </div>
      </div>
      {%  endif %}
   </div>
   <div class="row">
      <div {% if  not waybill_id and is_mds %} }} class="col-md-6 text-left" {% else %} class="col-md-6 text-left" {% endif %}>
      <button onclick="$('select[name=\'shipping_method\']').prop('disabled') ? $('a[href=\'#tab-payment\']').tab('show') : $('a[href=\'#tab-shipping\']').tab('show');" type="button"  class="btn btn-default"><i class="fa fa-arrow-left"></i>
      {{ button_back }}
      </button>
   </div>
   <div {% if  not waybill_id and is_mds %} }} class="col-md-6" {% else %} class="col-md-6" {% endif %}>
   <button type="button" id="button-mds-shipping" data-loading-text="{{ text_loading }}" class="pull-right btn btn-primary"><i class="fa fa-arrow-right"></i>
   {{ button_continue }}
   </button>
</div>
</div>
</div>
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[[data: $('#tab-payment input[type=\'text\'], #tab-payment input[type=\'hidden\'], #tab-payment input[type=\'radio\']:checked, #tab-payment input[type=\'checkbox\']:checked, #tab-payment select, #tab-payment textarea'),]]>
            </search>
            <add position="replace">
                <![CDATA[[
                    data: $('body').find('textarea, input, select').serialize(),
                ]]>
            </add>
        </operation>
    </file>
    <!-- End Admin Views -->
    <!-- Catalog views -->
    <file path="catalog/view/theme/default/template/checkout/checkout.twig|catalog/view/theme/default/template/account/address_form.twig">
        <operation>
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[
                <script type="text/javascript">
                    $(document)
                    .on('change', '[name="collivery_town"]', function(){
                        var elem = $(this);
                        var townId = elem.val();
                        $(document).find('[name="city"]').val(elem.find('option:selected').text());
                        var url = `index.php?route=checkout/checkout/getTownSuburbs&town_id=${townId}`;
                        $.get(url)
                            .done(function(response){
                                if($(response).attr('value') !== 'auth'){
                                   $('[name="collivery_suburb"]').empty().html(response);
                                }else if(!$(document).find('#collivery-alert').length){
                                    $('fieldset').prepend(`
                                        <div id="collivery-alert" class="alert alert-danger">
                                          <strong>Collivery.net</strong> Please contact admin to fix Collivery.net shipping extension.
                                        </div>`);
                                        console.error('Collivery Shipping Plugin Could Not Authenticate');
                                }
                            }).fail(function(xhr, ajaxOptions, thrownError) {
                                alert('Collivery suburbs could not be found!');
                                console.log('Could not find collivery suburb, please check if this plugin is installed properly');
                            });
                    }).ready(function(){
                          $(document).find('[name="city"]').closest('.form-group').attr('hidden', true)
                    });
                </script>
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/view/theme/default/template/checkout/guest.twig|catalog/view/theme/default/template/checkout/guest_shipping.twig|catalog/view/theme/default/template/checkout/register.twig|catalog/view/theme/default/template/checkout/shipping_address.twig|catalog/view/theme/default/template/checkout/payment_address.twig|catalog/view/theme/default/template/account/edit.twig|catalog/view/theme/default/template/account/address_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]"]]>
            </search>
            <add position="replace">
                <![CDATA[{% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %} {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}  name="collivery_{{ custom_field_name }}" {% else %}   name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" {% endif %} ]]>
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[<select name="custom_field[{{ custom_field.custom_field_id }}]" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">]]>
            </search>
            <add position="replace">
                <![CDATA[
                {% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %}

                {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}
                    <select name="payment_collivery_{{ custom_field_name }}" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                {% else %}
                    <select name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" id="input-payment-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                {% endif %}
                ]]>
            </add>
        </operation>
        <operation>
            <search index="0">
                <![CDATA[<script type="text/javascript">]]>
            </search>
            <add position="before">
                <![CDATA[
<div id="collivery-confirm-create-address-modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">

                <div class="row">
                    <div class="col-md-12">
                        <h4 style="text-align: center;">Do you want to create an address at Collivery.net for collivery shipping plugin installed</h4>
                        <p class="text-info">Please note that address will be created based on the information from the "Shipping Details" tab</p>
                        <ul>
                            <li>An address is required for a waybill to be created</li>
                            <li>Change in "Town" may affect price of a waybill</li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-left">
                        <button type="button" class="continue-to-mds-tab btn-sm btn btn-danger" data-dismiss="modal">No</button>
                    </div>
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-right">
                        <button id="yes-create-mds-address" type="button" class="continue-to-mds-tab btn-sm btn btn-success" data-dismiss="modal">Yes</button>
                    </div>
                    <div class="col-md-2"></div>
                </div>
            </div>

        </div>

    </div>
</div>
<div id="confirm-accept-price-and-create-waybill" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h4 style="text-align: center;">
                            Do you want to create a waybill, please note the following following pricing information
                        </h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <table class="table table-stripped">
                            <thead>
                            <tr>
                                <td colspan="2">The note the following pricing details</td>
                            </tr>
                            <tr>
                                <td>Item</td>
                                <td>Value</td>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Price Including VAT</td>
                                <td>{{ quote_data.price.inc_vat|round(2, 'floor') }}</td>
                            </tr>
                            {% for i,v in quote_data.price %}
                                <tr>
                                    <td>{{ i|upper }}</td>
                                    <td>{{ v }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-left">
                        <button type="button" class="btn-sm btn btn-danger" data-dismiss="modal">No</button>
                    </div>
                    <div class="col-md-2"></div>
                    <div class="col-md-3 text-right">
                        <button type="button" id="yes-accept-collivery" class="btn-sm btn btn-success" data-dismiss="modal">Yes</button>
                    </div>
                    <div class="col-md-2"></div>
                </div>
            </div>

        </div>

    </div>
</div>
                ]]>
            </add>
        </operation>
        <operation error="skip">
            <search index="0">
                <![CDATA[</script>]]>
            </search>
            <add position="after">
                <![CDATA[

<script>
    var Url = (new URL(window.location.href));
    var user_token = Url.searchParams.get('user_token');
    $(document)
    .ready(function(){
      (function(fields){
        fields.map(function(item){
          let select = $(document).find(`select[name="shipping_${item}"]`), option;
          if(item === 'collivery_town'){
            option = select.find("[value='{{ collivery_town }}']");
          }else if(item === 'collivery_suburb'){
            option = select.find("[value='{{ collivery_suburb }}']");
          }else{
            option = select.find("[value='{{ collivery_location_type }}']");
          }
          if(option){
            if(option.length){
              option.prop('selected', true);
            }else if(!option.length && item === 'collivery_suburb'){
              select.empty();
            }
          }
          $(document)
            .find(`[name="payment_${item}"]`)
                .closest('div.form-group.custom-field')
                    .remove();
        });
        $('#input-shipping-city').closest('div.form-group').prop('hidden', 'hidden');
      })(['collivery_town', 'collivery_suburb', 'collivery_location_type']);
    })
    .on('click', '#dispatched-collivery-button', function(a){
    a.preventDefault();
    var order = Url.searchParams.get('order_id');
    var from = $('[name="collection_shipping_address_id"]').val();
    var to = $('[name="delivery_shipping_address_id"]').val();
    $.getJSON(`index.php?route=sale/order/createCollivery&user_token=${window.user_token}&order=${order}&to=${to}&from=${from}`).done(function(response){
      if(response.hasOwnProperty('waybill_id')){
        //alert(response.waybill_id);
      }
    })
    })
    {% if not waybill_id %}
    .on('click', '#accept-waybill', function(a){
        a.preventDefault();
      $('#confirm-accept-price-and-create-waybill').modal('show');
    })
    .on('click', '#yes-accept-collivery', function(a){
      $.ajax(`index.php?route=sale/order/acceptAndCreateWaybill&user_token=${window.user_token}&order_id={{ order_id }}`).done(function(){
        window.location.reload(true);
      })
    })
    {% endif %}
    .on('click', '.continue-to-mds-tabg', function(a){
        $('a[href="#tab-mds"]').tab('show');
    })
    .on('change', '[name="shipping_collivery_town"]', function(){
    var elem = $(this);
      var townId = elem.val();
      $('[name="shipping_collivery_suburb"]').empty();

      var city = $('#input-shipping-city');

      city.closest('div.form-group').prop('hidden', 'hidden');

      city.val(elem.find('option:selected').text());

      $.ajax({
        url: `{{ constant('HTTP_CATALOG') }}index.php?route=checkout/checkout/getTownSuburbs&town_id=${townId}`,
        type: 'get',
        success: function(respond) {
          $('[name="shipping_collivery_suburb"]').html(respond);
        },
        error: function(xhr, ajaxOptions, thrownError) {
          console.log(thrownError);
          console.log('Could not find collivery suburb, please check if this plugin is installed properly');
        }
      });
    }).on('change', '[name="payment_collivery_town"]', function(){
      var townId = $(this).val();
      $('[name="payment_collivery_suburb"]').empty();
      $.ajax({
        url: `{{ constant('HTTP_CATALOG') }}index.php?route=checkout/checkout/getTownSuburbs&town_id=${townId}`,
        type: 'get',
        success: function(respond) {
          $('[name="payment_collivery_suburb"]').html(respond);
        },
        error: function(xhr, ajaxOptions, thrownError) {
          console.log(thrownError);
          console.log('Could not find collivery suburb, please check if this plugin is installed properly');
        }
      });
    })
    .on('click', '#button-mds-shipping', function(){
        $('a[href=\'#tab-total\']').tab('show');
    })
    .on('click', '#yes-create-mds-address', function(){
        var url = `index.php?route=sale/order/createColliveryAddress&user_token=${window.user_token}&order_id={{ order_id }}`;

        $.ajax({
          url : url,
          method:'post',
          dataType: 'json',
          data : $('#tab-shipping').find('select, textarea, input').serialize()
        }).done(function(response){
            var waybill_id = response.waybill_id;
            var waybill_status = '';
            var waybill_service = '';
            var collivery_from = response.collivery_from;
            var collivery_to = response.collivery_to;
            var html = `
              <div class="row">
                          <div class="col-md-4 text-left">
                              <h4>
                                  Waybill No: ${ waybill_id } <b></b>
                              </h4>
                          </div>
                          <div class="col-md-4 text-center">
                              <h4>
                                  Service Type: ${ waybill_service }<b></b>
                              </h4>
                          </div>
                          <div class="col-md-4 text-right">
                              <h4>
                                  Waybill Status: ${ waybill_status }<b></b>
                              </h4>
                          </div>
                      </div>
                     <div class="row">
                      <div class="col-md-12">
                          <table class="table table-bordered">
                              <tbody>
                              <tr>
                                  <td colspan="8" class="text-center text-uppercase bg-info">Collivery Information</td>
                              </tr>
                              <tr>
                                  <td width="50%" class="text-center"><b>Collection Address</b></td>
                                  <td width="50%" class="text-center"><b>Delivery Address</b></td>
                              </tr>
                              <tr>
                                  <td width="50%">${ collivery_from }</td>
                                  <td width="50%">${ collivery_to }</td>
                              </tr>
                            </tbody>
                          </table>
                      </div>
                  </div>
            `;

            $(document).find('#sub-tab-mds').html(html);
            $('a[href=\'#tab-mds\']').tab('show');


        });
    })
</script>
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.twig">
        <operation error="skip">
            <search>
                <![CDATA[<select name="custom_field[{{ custom_field.custom_field_id }}]" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control">]]>
            </search>
            <add position="replace">
                <![CDATA[
                {% set custom_field_name = custom_field.name|lower|replace({' ': '_'}) %}

                {% if(custom_field_name == 'location_type' or custom_field_name == 'town' or custom_field_name == 'suburb') %}
                    <select name="shipping_collivery_{{ custom_field_name }}" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control"
                    {% else %}
                    <select name="custom_field[{{ custom_field.location }}][{{ custom_field.custom_field_id }}]" id="input-shipping-custom-field{{ custom_field.custom_field_id }}" class="form-control">
                    {% endif %}
                ]]>
            </add>
        </operation>
    </file>
    <file path="catalog/model/account/custom_field.php">
        <operation>
            <search>
                <![CDATA[foreach ($custom_field_value_query->rows as $custom_field_value) {]]>
            </search>
            <add position="before">
                <![CDATA[
            /** @collivery-data **/

                if($this->collivery && !$this->collivery->hasErrors()){
                    if($custom_field['name'] === 'Location Type' || $custom_field['name'] === 'Town' || $custom_field['name'] === 'Suburb'){
                        $custom_field_value_query->rows = array();
                        if($custom_field['name'] == 'Location Type'){
                            $data_array = $location_types;
                        }elseif ($custom_field['name'] == 'Town'){
                            $data_array = $towns;
                        }else{
                            $data_array = $suburbs;
                        }
                        $custom_field_value_query->rows[] = array('custom_field_value_id' => 0, 'name' => 'Select ' . $custom_field['name']);
                        foreach ($data_array as $id => $name){
                            $custom_field_value_query->rows[] = array('custom_field_value_id' => $id, 'name' => $name);
                        }
                    }
                }
               /** @endcollivery-data **/
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[foreach ($custom_field_query->rows as $custom_field) {]]>
            </search>
            <add position="before">
                <![CDATA[
       /** @collivery-data **/
       if($this->collivery){
            $location_types = $this->collivery->getLocationTypes();
            $towns = $this->collivery->getTowns();
            $suburbs = $this->collivery->getAllSuburbs();
        }
       /** @endcollivery-data **/
                ]]>
            </add>
        </operation>
    </file>
    <file path="admin/model/customer/custom_field.php">
        <operation>
            <search index="0">
                <![CDATA[$custom_field_value_data = array();]]>
            </search>
            <add position="after">
                <![CDATA[
            /** @collivery-data **/
        $query = $this->db->query("select * from " . DB_PREFIX . "custom_field_description where custom_field_id={$custom_field_id}");
        if($query->num_rows){
            if($query->row['name'] === 'Town' || $query->row['name'] === 'Suburb' || $query->row['name'] === 'Location Type' && $this->collivery && !$this->collivery->hasErrors()){
                $locationtype = $this->collivery->getLocationTypes();
                $town = $this->collivery->getTowns();
                $suburb = $this->collivery->getAllSuburbs();
                $data = ${str_replace(' ', '', strtolower($query->row['name']))};
                foreach($data as $key => $val){
                    $custom_field_value_data[$key] = array(
                        'custom_field_value_id' => $key,
                        'name'                  => $val
                    );
                }
            }
            return $custom_field_value_data;
        }
               /** @endcollivery-data **/
                ]]>
            </add>
        </operation>
    </file>
    <!-- End Catalog Views -->
    <!-- END VIEWS -->
</modification>